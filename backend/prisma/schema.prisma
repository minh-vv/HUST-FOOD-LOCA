generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  user_id             Int                  @id @default(autoincrement())
  username            String               @unique @db.VarChar(50)
  email               String               @unique @db.VarChar(100)
  password_hash       String               @db.VarChar(255)
  full_name           String?              @db.VarChar(100)
  profile_image_url   String?              @db.VarChar(255)
  created_at          DateTime             @default(now())
  updated_at          DateTime             @default(now()) @updatedAt
  last_login          DateTime?
  country             String?              @db.VarChar(20)
  passwordResetTokens PasswordResetToken[]
  reviews             Review[]
  allergies           UserAllergy[]
  favorites           UserFavorite[]
  saved               UserSaved[]

  @@map("users")
}

model PasswordResetToken {
  id         Int       @id @default(autoincrement())
  token      String    @unique @db.VarChar(255)
  user_id    Int
  expires_at DateTime
  used       Boolean   @default(false)
  created_at DateTime  @default(now())
  used_at    DateTime?
  user       User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@map("password_reset_tokens")
}

model UserAllergy {
  allergy_id    Int        @id @default(autoincrement())
  user_id       Int
  ingredient_id Int
  created_at    DateTime   @default(now())
  ingredient    Ingredient @relation(fields: [ingredient_id], references: [ingredient_id], onDelete: Cascade)
  user          User       @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, ingredient_id], name: "unique_user_allergy")
  @@index([ingredient_id])
  @@index([user_id])
  @@map("user_allergies")
}

model Restaurant {
  restaurant_id        Int               @id @default(autoincrement())
  restaurant_name      String            @db.VarChar(200)
  address              String?           @db.Text
  average_service_time Int?
  google_map_url       String?           @db.VarChar(255)
  website_url          String?           @db.VarChar(255)
  description          String?           @db.Text
  created_at           DateTime          @default(now())
  updated_at           DateTime          @default(now()) @updatedAt
  images               RestaurantImage[]
  menu                 RestaurantMenu[]

  @@map("restaurants")
}

model RestaurantImage {
  image_id      Int        @id @default(autoincrement())
  restaurant_id Int
  image_url     String     @db.VarChar(255)
  display_order Int        @default(0)
  is_primary    Boolean    @default(false)
  created_at    DateTime   @default(now())
  restaurant    Restaurant @relation(fields: [restaurant_id], references: [restaurant_id], onDelete: Cascade)

  @@index([restaurant_id])
  @@map("restaurant_images")
}

model Dish {
  dish_id       Int         @id @default(autoincrement())
  dish_name     String      @db.VarChar(200)
  description   String?     @db.Text
  average_price Decimal?    @db.Decimal(10, 2)
  cuisine_type  String?     @db.VarChar(20)
  images        DishImage[]

  @@map("dishes")
}

model DishImage {
  image_id      Int      @id @default(autoincrement())
  dish_id       Int
  image_url     String   @db.VarChar(255)
  display_order Int      @default(0)
  is_primary    Boolean  @default(false)
  created_at    DateTime @default(now())
  dish          Dish     @relation(fields: [dish_id], references: [dish_id], onDelete: Cascade)

  @@index([dish_id])
  @@map("dish_images")
}

model Ingredient {
  ingredient_id   Int              @id @default(autoincrement())
  ingredient_name String           @unique @db.VarChar(100)
  created_at      DateTime         @default(now())
  menuIngredients MenuIngredient[]
  userAllergies   UserAllergy[]

  @@map("ingredients")
}

model RestaurantMenu {
  menu_id       Int              @id @default(autoincrement())
  restaurant_id Int
  price         Decimal?         @db.Decimal(10, 2)
  is_available  Boolean          @default(true)
  created_at    DateTime         @default(now())
  updated_at    DateTime         @default(now()) @updatedAt
  flavors       MenuFlavor[]
  menu_images   menu_images[]
  ingredients   MenuIngredient[]
  restaurant    Restaurant       @relation(fields: [restaurant_id], references: [restaurant_id], onDelete: Cascade)
  reviews       Review[]
  favorites     UserFavorite[]
  saved         UserSaved[]

  @@index([restaurant_id])
  @@map("restaurant_menu")
}

model MenuIngredient {
  menu_ingredient_id Int            @id @default(autoincrement())
  menu_id            Int
  ingredient_id      Int
  is_main            Boolean        @default(false)
  created_at         DateTime       @default(now())
  ingredient         Ingredient     @relation(fields: [ingredient_id], references: [ingredient_id], onDelete: Cascade)
  menu               RestaurantMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)

  @@unique([menu_id, ingredient_id], name: "unique_menu_ingredient")
  @@index([menu_id])
  @@index([ingredient_id])
  @@map("menu_ingredients")
}

model Flavor {
  flavor_id   Int          @id @default(autoincrement())
  flavor_name String       @unique @db.VarChar(50)
  created_at  DateTime     @default(now())
  menuFlavors MenuFlavor[]

  @@map("flavors")
}

model MenuFlavor {
  menu_flavor_id Int            @id @default(autoincrement())
  menu_id        Int
  flavor_id      Int
  intensity      Int            @default(3)
  created_at     DateTime       @default(now())
  flavor         Flavor         @relation(fields: [flavor_id], references: [flavor_id], onDelete: Cascade)
  menu           RestaurantMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)

  @@unique([menu_id, flavor_id], name: "unique_menu_flavor")
  @@index([menu_id])
  @@index([flavor_id])
  @@map("menu_flavors")
}

model Review {
  review_id  Int            @id @default(autoincrement())
  user_id    Int
  menu_id    Int
  rating     Int
  comment    String?        @db.Text
  has_image  Boolean        @default(false)
  created_at DateTime       @default(now())
  updated_at DateTime       @default(now()) @updatedAt
  images     ReviewImage[]
  menu       RestaurantMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)
  user       User           @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id, menu_id], map: "idx_user_menu_review")
  @@index([menu_id])
  @@index([user_id])
  @@map("reviews")
}

model ReviewImage {
  image_id   Int      @id @default(autoincrement())
  review_id  Int
  image_url  String   @db.VarChar(255)
  created_at DateTime @default(now())
  review     Review   @relation(fields: [review_id], references: [review_id], onDelete: Cascade)

  @@index([review_id])
  @@map("review_images")
}

model UserFavorite {
  favorite_id Int            @id @default(autoincrement())
  user_id     Int
  menu_id     Int
  created_at  DateTime       @default(now())
  menu        RestaurantMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)
  user        User           @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, menu_id], name: "unique_user_favorite")
  @@index([menu_id])
  @@index([user_id])
  @@map("user_favorites")
}

model UserSaved {
  saved_id   Int            @id @default(autoincrement())
  user_id    Int
  menu_id    Int
  created_at DateTime       @default(now())
  menu       RestaurantMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)
  user       User           @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, menu_id], name: "unique_user_saved")
  @@index([menu_id])
  @@index([user_id])
  @@map("user_saved")
}

model menu_images {
  image_id        Int            @id @default(autoincrement())
  menu_id         Int
  image_url       String         @db.VarChar(255)
  display_order   Int?           @default(0)
  is_primary      Boolean?       @default(false)
  created_at      DateTime?      @default(now()) @db.DateTime(0)
  restaurant_menu RestaurantMenu @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_menu")

  @@index([menu_id], map: "idx_menu_id")
}
